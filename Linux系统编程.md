[toc]

# Linux/Unix系统编程

## 第12章 系统和进程信息

### 12.1 /proc文件系统

许多UNIX系统提供/proc虚拟文件系统，驻留在/proc目录中，包含了各种用于查看内核信息的文件，允许进程通过常规文件I/O调用来查看

> /proc称为虚拟文件系统：其中包含的文件和子目录并未存储在磁盘，是由内核在进程访问此类信息时动态创建

#### 12.1.1 进程相关的信息：/proc/PID

|  文件   |           描述 （进程属性）            |
| :-----: | :------------------------------------: |
| cmdline |          以\0分隔的命令行参数          |
|   cwd   |       指向当前工作目录的符号链接       |
| environ |        键值对形式的环境变量列表        |
|   fd    | 目录，包含指向进程所打开文件的符号链接 |
| root | 指向根目录的符号链接 |
| status | 文件，包含进程的各种信息（进程ID，内存使用，信号） |
| task | 目录，包含进程内每个线程的相关信息 |
| maps | 进程的内存映射 |
| mounts | 进程的挂载点 |
| exe | 符号链接，指向正在执行的文件 |
| mem | 进程的虚拟内存 |



#### 12.1.2 /proc目录下的系统信息

|目录|目录中的信息|
|:-:|:-:|
|/proc/net|有关网络和套接字的状态信息|
|/proc/sys/fs|文件系统的相关设置|
|/proc/sys/kernel|内核相关的设置|
|/proc/sys/net|网络和套接字的设置|
|/proc/sys/vm|内存管理设置|
|/proc/sysvipc|有关system V IPC对象的信息|




## 第14章 系统编程概念

### 14.1 设备（专用）文件

设备专用文件与系统的某一设备相对应。在内核中，每种**设备类型**都有与之对应的**驱动程序**，用于处理设备的所有I/O请求。

设备分类：

* 字符型设备，基于每个字符处理数据（如 终端和键盘）
* 块设备，每次处理一块数据，块的大小取决于设备类型，磁盘和磁带都属于块设备

设备文件一般位于/dev目录下，可使用`mknod`命令创建设备文件

#### 设备ID

每个设备文件主ID和辅ID各一个，主ID标识一般的设备等级（**同一类型**设备），辅ID在一般等级中唯一标识特定设备（`ls -l`命令可以查看主、辅ID）

设备文件的inode节点记录了设备文件的主、辅ID，每个**设备驱动程序**将自己与**特定主设备号**的关联关系向内核注册，从而建立设备文件与设备驱动程序之间的关系。

### 14.2 磁盘和分区

>  普通文件和目录通常放在硬盘设备（磁盘）

#### 磁盘驱动器

磁盘驱动器是一种机械设备，组成部分：

1. 多个同心圆组成的**磁道**，同一个磁道分为多个**扇区**，每个扇区包含一系列**物理块**（一般为512字节）
2. 磁头，在磁盘上快速移动，可**获取/修改**磁盘表面的**磁性编码信息**

**物理块**代表磁盘驱动器读写的**最小单元**



磁盘读写的过程：

* 磁盘移动到相应的磁道（**寻道时间**）
* 在相应扇区旋转到磁头下面之前，驱动器会一直等待（**旋转延迟**）
* 最后，从所请求的块上传输数据（**传输时间**）

执行上述**磁盘**操作的时间，可供CPU执行**数百万条**指令

#### 磁盘分区

> fdisk -l  可以列出磁盘的所有分区
>
> /proc/partitions 文件记录了每个磁盘分区的主辅设备号、大小和名称

每块磁盘分为一个或多个分区，一般包括：

* 文件系统，用于存放常规文件
* 数据区域，用作裸设备对其进行访问
* 交换区域：供内存管理使用

### 14.3 文件系统

> 文件系统是对常规文件和目录的组织集合，mkfs用于创建文件系统
>
> 最常见的文件系统是ext2
>
> /proc/filesystems中可以查看当前内核所知的所有文件系统类型

#### 文件系统结构

> 文件系统中分配的基本单元是**逻辑块**，对应文件系统所在磁盘设备上若干个**连续的物理块**
>
> 在ext2文件系统中，逻辑块的大小为1024、2048或者4096字节

**文件系统包含在磁盘分区**中，主要组成为：

* **引导块**，文件系统的**首块**，它不为文件系统所用，其中包含的信息用来**引导操作系统**（操作系统只需要一个引导块，但是所有文件系统都设有引导块）
* **超级块**，**引导块之后**的一个独立块，包含文件系统有关的信息，包括：
  * inode节点表的容量
  * 文件系统中逻辑块的大小
  * 文件系统中**逻辑块的数量**
* **inode**节点表，文件系统的每个文件或者目录都对应inode节点表中的一条记录，其中记录了文件的元数据信息
* **数据块**，用于存放文件中实际的数据

### 14.4 inode节点

>  驻留在文件系统的每个文件，在inode表中都会对应一个inode（`ls -li`可查看inode信息）

**inode节点**包含的信息包括：

* 文件类型（常规文件、目录、符号链接或者字符设备等）
* 用户，用户组（UID，GID）
* 三类用户的访问权限（user,group,others）
* 三个时间戳
  * 文件最后访问时间（`ls -lu`显示）
  * 文件最后修改时间（`ls -l`显示）
  * 文件状态的最后改变时间（`ls -lc`显示）
  * 大部分文件系统不会记录文件的**创建时间**
* 指向文件的硬链接数量
* 文件大小（字节为单位）
* 实际分配给文件的**块数量**（512字节为一个快），不一定完全等于文件字节大小（由于**文件黑洞**，实际分配给文件的块数可能会低于根据文件正常字节大小所计算出来的块数）
* 执行文件数据块的指针

#### ext2中的inode和数据块指针

ext2在存储文件时，数据块不一定连续，也可能不按照顺序存放。

内核在inode节点中维护了一组指针，用于定位文件数据块。每个inode包含15个指针，其中前12个指针是直接指向文件的前12个数据块，接着还有一个**间接指针**，一个**双重间接指针**，一个**三重间接指针**。

间接指针不直接指向数据块，而是指向**指针块**，其中指针的数量取决于文件系统中逻辑块的大小，由于指针大小为4字节，因此指针的数量在256（块大小1024字节）~1024（块大小4096字节）之间。

![img](https://img-blog.csdn.net/20160701230843587?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

inode指针设计：

* 在维护inode节点大小固定的同时，支持任意大小的文件
* 文件的数据块可以不连续，可以通过`lseek()`随机访问文件
* 对于大多数小文件，可以通过直接指针快速访问数据块

* 允许文件可以有**黑洞**（将inode节点和间接指针块的相应指针打上标记0，表名并未指向实际的磁盘块，这部分文件黑洞不会分配数据块空间）

### 14.5 虚拟文件系统（VFS）

VFS设计原理：

1. 定义一套通用接口，所有与文件交互的程序按照这些统一接口操作
2. 每种实际的文件系统根据自己的实际情况，提供不同VFS接口的实现

底层文件系统会将错误代码传回VFS层，VFS会将错误代码传回应用程序

### 14.6 日志文件系统

> 文件的一致性检查：系统崩溃时，文件的更新可能只完成了一部分，文件系统元数据（目录项、inode信息、数据块指针）处于不一致的状态，系统重启时，需要遍及整个文件系统进行检查，过程比较耗时

日志文件系统避免了漫长的一致性检查

* 在实际更新元数据之前，会先将更新操作记录与专用的磁盘日志文件中，对元数据的更新以**事务**的方式进行
* 一旦系统崩溃，系统重启后利用日志重做（redo）任何不完整的更新
* 文件状态很快恢复，但是**增加了文件更新的时间**

常见的日志文件系统：

1. Reiserfs
2. ext3
3. JFS
4. XFS
5. ext4
6. Btrfs

### 14.7 单根目录层级和挂载点

> Linux中所有文件系统的文件都位于单根目录树下，树根为根目录"/"。其他文件系统都挂载到根目录之下，视为整个目录层级的子树

挂载命令

```bash
mount device directory
```

### 14.10 虚拟内存文件系统：tmpfs

普通的文件系统都驻留在磁盘上，同时Linux也支持驻留在内存中的虚拟文件系统

最复杂的为**tmpfs**，和其他内存文件系统不同在于它属于**虚拟内存文件系统**，它不仅使用RAM，在RAM耗尽的情况下，还会使用**交换空间**。

创建tmpfs的命令

```bash
mount -t tmpfs source target

# 示例
mount -t tmpfs newtmp /tmp
```

* source：可以为任意名称
* target：该文件系统的挂载点

除了用于用户应用程序之外，tmpfs还有两个特殊用途：

* 内核**内部挂载**的隐形tmpfs，用于**实现System V共享内存和共享匿名内存映射**
* 挂载与**/tmp/shm**的tmpfs，为glibc用于**实现POSIX共享内存和POSIX信号量**



## 第18章 目录和链接



## 第34章 进程组、会话和作业控制



## 第37章 DAEMON守护进程

